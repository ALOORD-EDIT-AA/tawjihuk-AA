<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹</title>
  <style>
    /*
      v6:
      - Softer contrast (less harsh separators)
      - Theme picker (red/blue/green/yellow/pink) with unified tints
      - Responsive (iPad + laptop)
    */

    :root{
      color-scheme: dark;

      /* Base surfaces (softer, closer values) */
      --bg0:#0a0f1d;
      --bg1:#0c1222;
      --bg2:#0f1730;

      --text:#f1f4ff;
      --muted:rgba(241,244,255,0.78);
      --muted2:rgba(241,244,255,0.62);

      /* Neutral borders: subtle (no harsh lines) */
      --bd: rgba(255,255,255,0.10);
      --bd2: rgba(255,255,255,0.07);

      /* Accent (changes by theme) */
      --accent: #7aa2ff;   /* default blue */
      --accent2: rgba(122,162,255,0.18);
      --accent3: rgba(122,162,255,0.10);
      --accentGlow: rgba(122,162,255,0.18);
      --accentWash: rgba(122,162,255,0.06);

      /* State colors (kept consistent, but softened) */
      --ok: #22c55e;
      --no: #ef4444;
      --warn: #f59e0b;

      --shadow: 0 10px 30px rgba(0,0,0,0.28);
      --radius: 18px;

      /* Typography */
      --base:17px;
      --h1:20px;
      --small:14px;

      /* Layout */
      --maxw: 1120px;
    }
    @media (min-width:768px){ :root{ --base:18px; --h1:22px; --small:14.5px; } }
    @media (min-width:1200px){ :root{ --base:18.5px; --h1:24px; --small:15px; } }

    /* Theme tokens (accent + derived tints) */
    [data-theme="blue"]  { --accent:#7aa2ff; --accent2:rgba(122,162,255,0.28); --accent3:rgba(122,162,255,0.14); --accentGlow:rgba(122,162,255,0.20); --accentWash:rgba(122,162,255,0.08); }
    [data-theme="red"]   { --accent:#ff5d75; --accent2:rgba(255,93,117,0.28); --accent3:rgba(255,93,117,0.14); --accentGlow:rgba(255,93,117,0.20); --accentWash:rgba(255,93,117,0.08); }
    [data-theme="green"] { --accent:#32d07d; --accent2:rgba(50,208,125,0.28); --accent3:rgba(50,208,125,0.14); --accentGlow:rgba(50,208,125,0.20); --accentWash:rgba(50,208,125,0.08); }
    [data-theme="yellow"]{ --accent:#ffd166; --accent2:rgba(255,209,102,0.28); --accent3:rgba(255,209,102,0.14); --accentGlow:rgba(255,209,102,0.20); --accentWash:rgba(255,209,102,0.08); }
    [data-theme="pink"]  { --accent:#ff7ad9; --accent2:rgba(255,122,217,0.28); --accent3:rgba(255,122,217,0.14); --accentGlow:rgba(255,122,217,0.20); --accentWash:rgba(255,122,217,0.08); }

    html,body{
      margin:0;
      background: linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 55%, var(--bg2) 100%);
      color:var(--text);
      font:400 var(--base)/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }
    /* One global blurred color layer for REAL blending (no hard lines) */
    body::before{
      content:"";
      position: fixed;
      inset: -80px;
      pointer-events:none;
      z-index: 0;
      background:
        radial-gradient(1200px 700px at 18% 12%, var(--accentGlow), transparent 68%),
        radial-gradient(1100px 800px at 82% 5%, rgba(255,255,255,0.05), transparent 72%),
        radial-gradient(1400px 900px at 50% 110%, rgba(0,0,0,0.38), transparent 62%),
        radial-gradient(900px 600px at 55% 45%, var(--accentWash), transparent 70%);
      filter: blur(34px) saturate(1.08);
      opacity: 1;
      transform: translateZ(0);
    }
    body::after{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events:none;
      z-index: 0;
      background: radial-gradient(1200px 700px at 50% -20%, rgba(255,255,255,0.03), transparent 70%);
      opacity: .9;
    }

    /* Ensure app content is above the global background layers */
    .wrap{ position: relative; z-index: 1; }


    .wrap{max-width:var(--maxw);margin:0 auto;padding:16px}

    .top{
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      padding:16px;border:1px solid rgba(255,255,255,0.08);border-radius:var(--radius);
      background: rgba(255,255,255,0.045);
      box-shadow: var(--shadow);
      position:sticky;top:0;backdrop-filter: blur(12px);z-index:10;
    }

    h1{margin:0;font-size:var(--h1); letter-spacing: .2px}
    .muted{color:var(--muted);font-size:var(--small)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{
      padding:10px 12px;border-radius:999px;
      background: var(--accent3);
      border:1px solid rgba(255,255,255,0.10);
      font-size:var(--small);white-space:nowrap
    }

    .btn{
      cursor:pointer;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.045);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-size:var(--small);
      transition: transform .06s ease, filter .12s ease, box-shadow .12s ease;
      user-select:none;touch-action:manipulation;
    }
    .btn:hover{filter:brightness(1.08)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background: var(--accent3);
      border-color: rgba(255,255,255,0.14);
      box-shadow: 0 0 0 4px rgba(0,0,0,0.08) inset;
    }
    .btn.danger{
      background: rgba(255,93,117,0.10);
      border-color: rgba(255,93,117,0.22);
    }
    .btn.ghost{background:transparent}

    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}

    .card{
      border:1px solid rgba(255,255,255,0.08);
      border-radius:var(--radius);
      background: rgba(255,255,255,0.04);
      padding:16px;
      box-shadow: var(--shadow);
    }
    .card-head{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .dayname{font-weight:800;font-size:18px}
    .date{font-size:var(--small);color:var(--muted2)}

    .inputRow{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap}
    input[type="text"]{
      flex:1;min-width:230px;padding:12px;border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      color:var(--text);font-size:var(--base);outline:none;
    }
    input[type="text"]::placeholder{color:rgba(241,244,255,0.55)}

    .summary{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;color:var(--muted);font-size:var(--small)}
    .summary b{color:var(--text)}

    .progress{
      margin-top:10px;
      border:1px solid rgba(255,255,255,0.08);
      border-radius:999px;
      background: rgba(0,0,0,0.16);
      height:16px
    }
    .bar{height:100%;width:0%;background: var(--accent); transition: width .35s ease}

    .chart{
      border:1px solid rgba(255,255,255,0.08);
      border-radius:var(--radius);
      padding:16px;
      background: rgba(255,255,255,0.04);
      box-shadow: var(--shadow);
      position: relative; }
    .chart-title{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:baseline}
    .chart-title b{font-size:18px}
    .hint{margin-top:10px;font-size:var(--small);color:var(--muted2)}
    .sep{height:1px;background: rgba(255,255,255,0.08);margin:14px 0}

    .bars{display:flex;gap:10px;align-items:flex-end;height:160px;margin-top:10px}
    .barcol{flex:1;display:flex;flex-direction:column;gap:8px;align-items:stretch;min-width:0}
    .barbox{
      flex:1;
      border:1px solid rgba(255,255,255,0.08);
      border-radius:14px;
      background: rgba(0,0,0,0.16);
      display:flex;align-items:flex-end
    }
    .fill{width:100%;height:0%;background: var(--accent); transition: height .35s ease}
    .label,.num{font-size:13px;color:var(--muted2);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .num{color:var(--muted)}

    .tasks{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .task{
      border:1px solid rgba(255,255,255,0.08);
      border-radius:16px;
      padding:12px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      background: rgba(0,0,0,0.12);
      flex-wrap:wrap;
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
    }
    .task-left{display:flex;gap:10px;align-items:center;flex:1;min-width:260px}
    .task-title{flex:1;font-size:var(--base)}
    .status{display:flex;gap:10px;align-items:center;white-space:nowrap}

    .chip{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      cursor:pointer;
      font-size:var(--small);
      user-select:none;touch-action:manipulation;
      transition: transform .08s ease, filter .12s ease, box-shadow .12s ease;
    }
    .chip:hover{filter:brightness(1.06)}
    .chip:active{transform:translateY(1px)}
    .chip.on-ok{background: rgba(34,197,94,0.10); border-color: rgba(34,197,94,0.22); box-shadow: 0 0 0 4px rgba(34,197,94,0.06); }
    .chip.on-no{background: rgba(239,68,68,0.10); border-color: rgba(239,68,68,0.22); box-shadow: 0 0 0 4px rgba(239,68,68,0.06); }

    .pulse { animation: pulse .35s ease; }
    @keyframes pulse{ 0%{transform:scale(1)} 50%{transform:scale(1.02)} 100%{transform:scale(1)} }

    .shake { animation: shake .32s ease; }
    @keyframes shake{
      0%{transform:translateX(0)} 25%{transform:translateX(-6px)}
      50%{transform:translateX(6px)} 75%{transform:translateX(-4px)}
      100%{transform:translateX(0)}
    }

    .task.done{ border-color: rgba(34,197,94,0.18); box-shadow: 0 0 0 4px rgba(34,197,94,0.05); }
    .task.notdone{ border-color: rgba(239,68,68,0.18); box-shadow: 0 0 0 4px rgba(239,68,68,0.05); }

    .banner{
      margin-top:12px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.12);
      color:var(--text);
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .banner.show{display:flex}
    .banner.ok{ border-color: rgba(34,197,94,0.22); background: rgba(34,197,94,0.08); }
    .banner.warn{ border-color: rgba(245,158,11,0.22); background: rgba(245,158,11,0.07); }
    .banner small{color:var(--muted)}
    .kbd{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.10);background: rgba(0,0,0,0.16);color:var(--muted);}

    /* Confetti */
    #confetti{position:fixed; inset:0; pointer-events:none; display:none; z-index:9999;}

    /* Theme picker */
    .themePick{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
    }
    .dot{
      width:22px; height:22px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      cursor:pointer;
      transition: transform .08s ease, filter .12s ease;
    }
    .dot:hover{filter:brightness(1.08)}
    .dot:active{transform:translateY(1px)}
    .dot.sel{ box-shadow: 0 0 0 4px rgba(255,255,255,0.06); }

    .dot.blue{ background:#7aa2ff; }
    .dot.red{ background:#ff5d75; }
    .dot.green{ background:#32d07d; }
    .dot.yellow{ background:#ffd166; }
    .dot.pink{ background:#ff7ad9; }

    /* Dialog (kept from v5, softened) */
    dialog{
      border:1px solid rgba(255,255,255,0.10);
      border-radius:16px;
      background: rgba(10,14,28,0.96);
      color: var(--text);
      box-shadow: var(--shadow);
      width: min(720px, calc(100% - 24px));
    }
    dialog::backdrop{ background: rgba(0,0,0,0.55); }
    textarea{
      width:100%;
      min-height:180px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.16);
      color: var(--text);
      padding: 12px;
      font-size: 14px;
      resize: vertical;
    }

    @media(pointer:coarse){
      .btn{padding:12px 14px}
      .chip{padding:12px 14px}
      input[type="text"]{padding:14px}
      .dot{width:26px;height:26px}
    }
  
    /* Bottom fixed navigation */
    .bottomNav{
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 12px;
      z-index: 20;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 999px;
      background: rgba(255,255,255,0.045);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      padding: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      max-width: var(--maxw);
      margin: 0 auto;
    }
    .bottomNav .group{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .bottomNav .mini{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
      color: var(--muted);
      font-size: var(--small);
      white-space: nowrap;
    }
    /* keep content visible above fixed bar */
    .spacerBottom{ height: 92px; }
    @media (pointer: coarse){
      .bottomNav{ bottom: 14px; padding: 12px; }
      .spacerBottom{ height: 104px; }
    }

    /* Notes (message to self) */
    .notesCard{
      margin-top: 14px;
      border:1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      background: rgba(255,255,255,0.04);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .notesHeader{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:baseline;
    }
    .notesHeader b{ font-size: 18px; }
    .notesTools{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .notesCard textarea{
      margin-top: 10px;
      min-height: 140px;
      font-size: 15px;
      line-height: 1.6;
    }

  
    /* ===== Two fixed top bars (do not move on scroll) ===== */
    :root{
      --topGap: 12px;
      --topMainH: 92px;   /* updated by JS */
      --topSecondH: 72px; /* updated by JS */
    }

    .top{
      position: fixed !important;
      top: var(--topGap);
      left: var(--topGap);
      right: var(--topGap);
      z-index: 60;
    }

    /* second bar: was bottomNav, now fixed under the main top bar */
    .bottomNav{
      position: fixed !important;
      left: var(--topGap);
      right: var(--topGap);
      top: calc(var(--topGap) + var(--topMainH) + 10px);
      bottom: auto !important;
      z-index: 55;
      max-width: var(--maxw);
      margin: 0 auto;
    }

    /* push page content below the two fixed bars */
    .wrap{
      padding-top: calc(var(--topGap) + var(--topMainH) + 10px + var(--topSecondH) + 18px);
    }

    /* spacer no longer needed (kept harmless if present) */
    .spacerBottom{ height: 20px !important; }


    /* Weekly tasks (end of page) */
    .weeklyCard{
      margin-top: 14px;
      border:1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      background: rgba(255,255,255,0.04);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .weeklyHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .weeklyHead b{ font-size:18px; }
    .weeklyMeta{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .weeklyMeta .pill{ background: rgba(255,255,255,0.05); }
    .weeklyProgressRow{ margin-top:10px; }


    /* ===== Responsive polish for all devices (phones / iPad / laptops) ===== */

    /* Fluid type without changing your design */
    :root{
      --base: clamp(16px, 1.9vw, 19px);
      --h1: clamp(19px, 2.3vw, 26px);
      --small: clamp(13px, 1.55vw, 15.5px);
    }

    /* Safer padding on devices with notch / home indicator */
    body{
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }

    .wrap{
      padding: clamp(12px, 2.2vw, 18px);
    }

    /* Make header rows wrap nicely on small screens */
    .top{ gap: 10px; }
    .row{ gap: 8px; }

    /* Inputs: prevent overflow on narrow screens */
    input[type="text"]{
      min-width: min(230px, 100%);
      width: 100%;
    }
    .inputRow{ align-items: stretch; }
    .inputRow > input[type="text"]{ flex: 1 1 260px; }
    .inputRow > button{ flex: 0 0 auto; }

    /* Task row: allow clean wrapping on phones */
    .task-left{ min-width: min(260px, 100%); }

    /* Chart bars: scale down on small screens */
    .bars{ height: clamp(120px, 28vw, 160px); }

    /* Prevent any horizontal scrolling */
    html, body { overflow-x: hidden; }

    /* Better tap targets on touch devices */
    @media (pointer: coarse){
      .btn{ min-height: 44px; }
      .chip{ min-height: 44px; }
      input[type="text"]{ min-height: 44px; }
    }

    /* Phones: single-column layout and tighter spacing */
    @media (max-width: 520px){
      .grid{ grid-template-columns: 1fr; }
      .pill{ width: 100%; text-align: center; }
      .themePick{ width: 100%; justify-content: space-between; }
      .bottomNav{ border-radius: 18px; }
      .bottomNav .group{ width: 100%; justify-content: space-between; }
      .bottomNav .mini{ flex: 1 1 auto; text-align:center; }
    }

    /* Tablets: keep two columns when possible */
    @media (min-width: 700px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    /* Reduce motion if user prefers */
    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; scroll-behavior: auto !important; }
    }

</style>
</head>

<body data-theme="blue">
  <canvas id="confetti"></canvas>

  <div class="wrap">
    <div class="top">
      <div>
        <h1>Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ (Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø·)</h1>
        <div class="muted" id="todayLine">â€”</div>
      </div>

      <div class="row">
        <div class="themePick" title="ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù…ÙˆÙ‚Ø¹">
          <span class="muted" style="margin-inline-start:4px;">Ø§Ù„Ù„ÙˆÙ†:</span>
          <div class="dot blue"  data-theme="blue"  aria-label="Ø£Ø²Ø±Ù‚"></div>
          <div class="dot red"   data-theme="red"   aria-label="Ø£Ø­Ù…Ø±"></div>
          <div class="dot green" data-theme="green" aria-label="Ø£Ø®Ø¶Ø±"></div>
          <div class="dot yellow"data-theme="yellow"aria-label="Ø£ØµÙØ±"></div>
          <div class="dot pink"  data-theme="pink"  aria-label="Ø²Ù‡Ø±ÙŠ"></div>
        </div>

        <button class="btn ghost" id="prevWeek">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <button class="btn ghost" id="nextWeek">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„ØªØ§Ù„ÙŠ</button>
        <button class="btn primary" id="goThisWeek">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>

        <button class="btn primary" id="exportBtn">ØªØµØ¯ÙŠØ±</button>
        <button class="btn" id="importBtn">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>

        <div class="pill" id="weekRange">â€”</div>
        <div class="pill" id="globalLine">â€”</div>
        <button class="btn danger" id="resetAll">Ø­Ø°Ù</button>
      </div>
    </div>

    <div class="chart" id="weeklyChart">
      <div class="chart-title">
        <div><b>Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶)</b> <span class="muted">(ÙƒÙ„ Ø¹Ù…ÙˆØ¯ = ÙŠÙˆÙ…)</span></div>
        <div class="muted" id="chartStats">â€”</div>
      </div>

      <div class="progress" title="Ù†Ø³Ø¨Ø© Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹">
        <div class="bar" id="weekProgress"></div>
      </div>

      <div class="banner" id="weekBanner">
        <div id="bannerText">â€”</div>
        <div class="kbd" id="bannerHint">â€”</div>
      </div>

      <div class="hint" id="weekHint">â€”</div>
      <div class="sep"></div>
      <div class="bars" id="bars"></div>
      <div class="hint" id="overallHint">â€”</div>
    </div>

    <div class="grid" id="daysGrid"></div>

    <div class="notesCard" id="notesCard">
      <div class="notesHeader">
        <div>
          <b>Ø±Ø³Ø§Ù„Ø© Ù„Ù†ÙØ³Ùƒ</b>
          <div class="muted" id="notesSub">Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
        </div>
        <div class="notesTools">
          <button class="btn primary" id="saveNotesBtn">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
          <button class="btn" id="clearNotesBtn">Ù…Ø³Ø­</button>
        </div>
      </div>
      <textarea id="notesText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ù†ÙØ³Ùƒâ€¦ Ù…Ø«Ø§Ù„: Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙŠÙˆÙ…ÙŠÙ†ØŒ ÙˆØ®Ù„Ù‘Øµ Ø§Ù„ÙˆØ§Ø¬Ø¨ Ù‚Ø¨Ù„ Ø§Ù„Ù…ØºØ±Ø¨."></textarea>
      <div class="hint">ØªÙ†Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²ÙƒØŒ ÙˆÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù‡ Ù…Ù„Ø§Ø­Ø¸Ø© Ø®Ø§ØµØ©.</div>
    </div>


    <div class="weeklyCard" id="weeklyCard">
      <div class="weeklyHead">
        <div>
          <b>Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</b>
          <div class="muted" id="weeklySub">Ù…Ù‡Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
        </div>
        <div class="weeklyMeta">
          <div class="pill" id="weeklyStatsLine">â€”</div>
          <button class="btn danger" id="clearWeeklyBtn">Ù…Ø³Ø­ Ù…Ù‡Ø§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
        </div>
      </div>

      <div class="inputRow">
        <input id="weeklyInput" type="text" placeholder="Ø§ÙƒØªØ¨ Ù…Ù‡Ù…Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© (Ù…Ø«Ø§Ù„: Ø®ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ / Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙˆØ­Ø¯Ø©)" maxlength="140" />
        <button class="btn primary" id="weeklyAddBtn">Ø¥Ø¶Ø§ÙØ©</button>
      </div>

      <div class="weeklyProgressRow">
        <div class="progress" title="Ù†Ø³Ø¨Ø© Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©">
          <div class="bar" id="weeklyProgressBar"></div>
        </div>
      </div>

      <div class="tasks" id="weeklyTasksWrap"></div>
      <div class="hint">Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ø§Ù… ØªØ®ØªÙ„Ù Ø¹Ù† Ù…Ù‡Ø§Ù… Ø§Ù„Ø£ÙŠØ§Ù…. ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù‡ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‡Ø§Ù… Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ø®Ø§ØµØ©.</div>
    </div>


    <div class="spacerBottom"></div>

    <div class="bottomNav" role="navigation" aria-label="ØªÙ†Ù‚Ù„ Ø«Ø§Ø¨Øª">
      <div class="group">
        <button class="btn ghost" id="prevWeekBottom">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <button class="btn primary" id="thisWeekBottom">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
        <button class="btn ghost" id="nextWeekBottom">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„ØªØ§Ù„ÙŠ</button>
      </div>
      <div class="group">
        <div class="mini" id="bottomQuickStats">â€”</div>
        <button class="btn" id="scrollTopBtn">ÙÙˆÙ‚ â¬†ï¸</button>
      </div>
    </div>

  </div>

  <dialog id="ioDialog">
    <h3 style="margin:0 0 10px 0; font-size:18px;">Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</h3>
    <div class="muted" style="margin-bottom:10px;">
      Ø§Ù†Ø³Ø® Ø§Ù„Ù†Øµ (JSON) Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ Ø«Ù… Ø§Ù„ØµÙ‚Ù‡ ÙÙŠ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø«Ø§Ù†ÙŠ.
    </div>
    <textarea id="ioText" placeholder="Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ù„Ù†Øµ Ø¹Ù†Ø¯ Ø§Ù„ØªØµØ¯ÙŠØ±..."></textarea>
    <div class="row" style="margin-top:12px; justify-content:flex-start;">
      <button class="btn primary" id="copyBtn">Ù†Ø³Ø®</button>
      <button class="btn primary" id="applyImportBtn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
      <button class="btn danger" id="closeDialogBtn">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="muted" style="margin-top:10px;">
      Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø³ÙŠÙØ¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
    </div>
  </dialog>

<script>
(() => {
  const AR_DAYS = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];
  const pad2 = (n)=>String(n).padStart(2,"0");

  function formatDate(d){ return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`; }
  function isoDate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
  function addDays(d, days){ const x=new Date(d); x.setDate(x.getDate()+days); return x; }

  const LS_STATE = "weekly_ach_tracker_v6";
  const LS_OFFSET = "weekly_ach_weekOffset_v6";
  const LS_THEME = "weekly_ach_theme_v6";
  const LS_WEEKLY = "weekly_ach_weeklyTasks_v1"; // { [weekStartIso]: { tasks:[{id,title,status}] } }

  function loadState(){
    try { return JSON.parse(localStorage.getItem(LS_STATE) || "{}"); }
    catch { return {}; }
  }
  function saveState(state){ localStorage.setItem(LS_STATE, JSON.stringify(state)); }


  function loadWeekly(){
    try { return JSON.parse(localStorage.getItem(LS_WEEKLY) || "{}"); }
    catch { return {}; }
  }
  function saveWeekly(obj){ localStorage.setItem(LS_WEEKLY, JSON.stringify(obj)); }


  // status: "ok"(Ù…Ù†Ø¬Ø²) | "no"(ØºÙŠØ± Ù…Ù†Ø¬Ø²) | "none"(ØºÙŠØ± Ù…Ø­Ø¯Ø¯)
  function stats(tasks){
    const total = tasks.length;
    const done = tasks.filter(t => t.status === "ok").length;
    const notDone = tasks.filter(t => t.status === "no").length;
    const unset = tasks.filter(t => t.status === "none").length;
    const remaining = total - done;
    const pct = total === 0 ? 0 : Math.round((done / total) * 100);
    return { total, done, notDone, unset, remaining, pct };
  }

  // ===== Theme handling =====
  const body = document.body;
  const dots = Array.from(document.querySelectorAll(".dot"));
  function applyTheme(name){
    body.setAttribute("data-theme", name);
    localStorage.setItem(LS_THEME, name);
    for(const d of dots){
      d.classList.toggle("sel", d.dataset.theme === name);
    }
  }
  const savedTheme = localStorage.getItem(LS_THEME) || "blue";
  applyTheme(savedTheme);

  dots.forEach(d => d.addEventListener("click", () => applyTheme(d.dataset.theme)));

  // ===== Confetti =====
  const confettiCanvas = document.getElementById("confetti");
  const ctx = confettiCanvas.getContext("2d");
  let running=false, particles=[];
  function resize(){
    confettiCanvas.width = window.innerWidth * devicePixelRatio;
    confettiCanvas.height = window.innerHeight * devicePixelRatio;
    ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  window.addEventListener("resize", resize); resize();

  function startConfetti(durationMs=1200){
    if(running) return;
    running=true;
    confettiCanvas.style.display="block";
    particles=[];
    const W=window.innerWidth, H=window.innerHeight;
    const colors = ["var(--accent)","#22c55e","#f59e0b","#ef4444","#a78bfa","#38bdf8"];
    for(let i=0;i<120;i++){
      particles.push({
        x: Math.random()*W,
        y: -20 - Math.random()*H*0.2,
        vx: (Math.random()-0.5)*5,
        vy: 2 + Math.random()*5,
        w: 6 + Math.random()*6,
        h: 6 + Math.random()*10,
        r: Math.random()*Math.PI,
        vr: (Math.random()-0.5)*0.2,
        c: colors[Math.floor(Math.random()*colors.length)],
        a: 0.82 + Math.random()*0.18
      });
    }
    const start=performance.now();
    function tick(t){
      const e=t-start;
      ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
      for(const p of particles){
        p.x+=p.vx; p.y+=p.vy; p.r+=p.vr;
        p.vx*=0.995; p.vy*=0.995; p.vy+=0.03;
        ctx.save();
        ctx.translate(p.x,p.y); ctx.rotate(p.r);
        ctx.globalAlpha=p.a; ctx.fillStyle=p.c;
        ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
        ctx.restore();
      }
      if(e<durationMs) requestAnimationFrame(tick);
      else { running=false; confettiCanvas.style.display="none"; ctx.clearRect(0,0,window.innerWidth,window.innerHeight); }
    }
    requestAnimationFrame(tick);
  }

  // ===== Date baseline =====
  const now = new Date();
  document.getElementById("todayLine").textContent =
    `Ø§Ù„ÙŠÙˆÙ… (Ø­Ø³Ø¨ Ø¬Ù‡Ø§Ø²Ùƒ): ${AR_DAYS[now.getDay()]} â€” ${formatDate(now)} â€¢ ØªÙ‚Ø¯Ø± ØªØºÙŠÙ‘Ø± Ù„ÙˆÙ† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† ÙÙˆÙ‚`;

  const thisSunday = new Date(now);
  thisSunday.setDate(now.getDate() - now.getDay());
  let weekOffset = Number(localStorage.getItem(LS_OFFSET) || "0");

  const state = loadState();
  function ensureDay(key){ if(!state[key]) state[key] = { tasks: [] }; }

  const grid = document.getElementById("daysGrid");
  const barsEl = document.getElementById("bars");
  const weekBanner = document.getElementById("weekBanner");
  const bannerText = document.getElementById("bannerText");
  const bannerHint = document.getElementById("bannerHint");

  function getWeekDates(offset){
    const start = addDays(thisSunday, offset*7);
    return Array.from({length:7}, (_,i)=> addDays(start, i));
  }

  function allTimeStats(){
    let total=0, done=0;
    for(const k of Object.keys(state)){
      const tasks = state[k]?.tasks || [];
      total += tasks.length;
      done += tasks.filter(t => t.status === "ok").length;
    }
    const pct = total === 0 ? 0 : Math.round((done/total)*100);
    return { total, done, pct, remaining: total-done };
  }

  function animateEl(el, cls){
    if(!el) return;
    el.classList.remove(cls);
    void el.offsetWidth;
    el.classList.add(cls);
    setTimeout(()=> el.classList.remove(cls), 420);
  }

  let lastWeekPerfect=false;

  function render(){
    grid.innerHTML="";
    barsEl.innerHTML="";
    localStorage.setItem(LS_OFFSET, String(weekOffset));

    const weekDates = getWeekDates(weekOffset);
    const weekStart = weekDates[0];
    const weekEnd = weekDates[6];
    document.getElementById("weekRange").textContent = `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: ${formatDate(weekStart)} â†’ ${formatDate(weekEnd)}`;
    // notes for this week
    syncNotesUI(weekStart);
    // weekly tasks for this week
    renderWeekly(weekStart);

    let weekTotal=0, weekDone=0, weekNotDone=0, weekUnset=0;
    const perDay = [];

    for(const d of weekDates){
      const key = isoDate(d);
      ensureDay(key);
      const st = stats(state[key].tasks);
      weekTotal+=st.total; weekDone+=st.done; weekNotDone+=st.notDone; weekUnset+=st.unset;
      perDay.push({ d, key, st });
    }

    const weekRemaining = weekTotal - weekDone;
    const weekPct = weekTotal === 0 ? 0 : Math.round((weekDone/weekTotal)*100);

    document.getElementById("globalLine").textContent =
      `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: ${weekDone}/${weekTotal} âœ… â€” Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${weekRemaining} â€” ${weekPct}%`;
    bottomQuickStats.textContent = `âœ… ${weekDone}/${weekTotal} â€¢ ${weekPct}%`;

    document.getElementById("chartStats").textContent =
      `âœ… ${weekDone} â€¢ â³ ${weekRemaining} â€¢ âŒ ${weekNotDone} â€¢ â¬œ ${weekUnset}`;

    document.getElementById("weekProgress").style.width = `${weekPct}%`;

    // Banner
    weekBanner.className = "banner";
    if(weekTotal>0 && weekPct===100){
      weekBanner.classList.add("show","ok");
      bannerText.textContent = "ğŸ† Ø¨Ø·Ù„! ÙƒÙ…Ù„Øª ÙƒÙ„ Ù…Ù‡Ø§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 100%";
      bannerHint.textContent = "ØªÙ‡Ø§Ù†ÙŠÙ†Ø§ âœ¨";
      if(!lastWeekPerfect) startConfetti(1500);
      lastWeekPerfect=true;
    }else{
      lastWeekPerfect=false;
      if(weekTotal>0 && weekPct<=25){
        weekBanner.classList.add("show","warn");
        bannerText.textContent = "â³ Ù„Ø³Ù‡ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©â€¦ Ø§Ø¨Ø¯Ø£ Ø¨Ù…Ù‡Ù…Ø© ÙˆØ­Ø¯Ø©!";
        bannerHint.textContent = "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†";
      }else if(weekTotal>0 && weekPct>=75){
        weekBanner.classList.add("show");
        bannerText.textContent = "ğŸ”¥ Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ù‹Ø§! ÙƒÙ…Ù‘Ù„ ÙˆØ®Ù„Ø§Øµ";
        bannerHint.textContent = "Ù…Ù‡Ù…ØªÙŠÙ† ÙˆØªØ®Ù„Øµ";
      }
    }

    let hint = "Ø£Ø¶Ù Ù…Ù‡Ø§Ù…Ùƒ Ù„ÙƒÙ„ ÙŠÙˆÙ… (Ø¨Ø¹Ø¯Ø¯ Ø§Ù„Ù„ÙŠ Ø¨Ø¯Ùƒ Ø¥ÙŠØ§Ù‡). Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ = Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ØªÙŠ Ø£Ø¶ÙØªÙ‡Ø§.";
    if(weekTotal>0){
      hint = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø¢Ù† = ${weekTotal}. Ù…Ø«Ø§Ù„: 3 Ù…Ù‡Ø§Ù… Ù„ÙƒÙ„ ÙŠÙˆÙ… â‡’ 3Ã—7 = 21.`;
    }
    document.getElementById("weekHint").textContent = hint;

    const all = allTimeStats();
    document.getElementById("overallHint").textContent =
      `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù… (Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²): âœ… ${all.done}/${all.total} â€” Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${all.remaining} â€” ${all.pct}%`;

    // Bars
    for(const item of perDay){
      const short = AR_DAYS[item.d.getDay()].replace("Ø§Ù„","");
      const col = document.createElement("div");
      col.className = "barcol";

      const box = document.createElement("div");
      box.className = "barbox";

      const fill = document.createElement("div");
      fill.className = "fill";
      const pct = item.st.total===0 ? 0 : Math.round((item.st.done/item.st.total)*100);
      fill.style.height = `${pct}%`;
      box.appendChild(fill);

      const num = document.createElement("div");
      num.className = "num";
      num.textContent = `${item.st.done}/${item.st.total}`;

      const lbl = document.createElement("div");
      lbl.className = "label";
      lbl.textContent = short;

      col.appendChild(box);
      col.appendChild(num);
      col.appendChild(lbl);
      barsEl.appendChild(col);
    }

    // Day cards
    for(const item of perDay){
      const d=item.d, key=item.key, st=item.st;
      const dayName = AR_DAYS[d.getDay()];
      const tasks = state[key].tasks;

      const card = document.createElement("div");
      card.className = "card";

      const head = document.createElement("div");
      head.className = "card-head";

      const left = document.createElement("div");
      left.innerHTML = `<div class="dayname">${dayName}</div><div class="date">${formatDate(d)} â€¢ ${key}</div>`;

      const right = document.createElement("div");
      right.className = "row";

      const clearBtn = document.createElement("button");
      clearBtn.className = "btn danger";
      clearBtn.textContent = "Ù…Ø³Ø­ Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…";
      clearBtn.onclick = () => {
        state[key].tasks = [];
        saveState(state);
        render();
      };

      right.appendChild(clearBtn);
      head.appendChild(left);
      head.appendChild(right);

      const addRow = document.createElement("div");
      addRow.className = "inputRow";

      const input = document.createElement("input");
      input.type="text";
      input.placeholder="Ø§ÙƒØªØ¨ Ù…Ù‡Ù…Ø© (Ø±ÙŠØ§Ø¶ÙŠØ§Øª / Ø¹Ø±Ø¨ÙŠ / Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠâ€¦)";
      input.maxLength=120;

      const addBtn = document.createElement("button");
      addBtn.className="btn primary";
      addBtn.textContent="Ø¥Ø¶Ø§ÙØ©";
      addBtn.onclick = () => {
        const title=input.value.trim();
        if(!title) return;
        state[key].tasks.push({
          id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
          title,
          status:"none"
        });
        input.value="";
        saveState(state);
        animateEl(card,"pulse");
        render();
      };
      input.addEventListener("keydown", (e)=>{ if(e.key==="Enter") addBtn.click(); });

      addRow.appendChild(input);
      addRow.appendChild(addBtn);

      const summary = document.createElement("div");
      summary.className="summary";
      summary.innerHTML = `
        <div>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù…: <b>${st.total}</b></div>
        <div>âœ… Ù…Ù†Ø¬Ø²: <b>${st.done}</b></div>
        <div>â³ Ù…ØªØ¨Ù‚ÙŠ: <b>${st.remaining}</b></div>
        <div>Ø§Ù„ØªÙ‚Ø¯Ù…: <b>${st.pct}%</b></div>
      `;

      const prog = document.createElement("div");
      prog.className="progress";
      const bar = document.createElement("div");
      bar.className="bar";
      bar.style.width = `${st.pct}%`;
      prog.appendChild(bar);

      const tasksWrap = document.createElement("div");
      tasksWrap.className="tasks";

      for(const t of tasks){
        const row = document.createElement("div");
        row.className="task";
        if(t.status==="ok") row.classList.add("done");
        if(t.status==="no") row.classList.add("notdone");

        const left = document.createElement("div");
        left.className="task-left";

        const title = document.createElement("div");
        title.className="task-title";
        title.textContent=t.title;

        left.appendChild(title);

        const status = document.createElement("div");
        status.className="status";

        const okChip = document.createElement("div");
        okChip.className="chip" + (t.status==="ok" ? " on-ok" : "");
        okChip.textContent="âœ… Ù…Ù†Ø¬Ø²";
        okChip.onclick = () => {
          const wasOk = (t.status==="ok");
          t.status = wasOk ? "none" : "ok";
          saveState(state);
          animateEl(row,"pulse");
          if(!wasOk) startConfetti(420);
          render();
        };

        const noChip = document.createElement("div");
        noChip.className="chip" + (t.status==="no" ? " on-no" : "");
        noChip.textContent="âŒ ØºÙŠØ± Ù…Ù†Ø¬Ø²";
        noChip.onclick = () => {
          const wasNo = (t.status==="no");
          t.status = wasNo ? "none" : "no";
          saveState(state);
          animateEl(row,"shake");
          render();
        };

        const editBtn = document.createElement("button");
        editBtn.className="btn";
        editBtn.textContent="ØªØ¹Ø¯ÙŠÙ„";
        editBtn.onclick = () => {
          const newTitle = prompt("Ø¹Ø¯Ù‘Ù„ Ù†Øµ Ø§Ù„Ù…Ù‡Ù…Ø©:", t.title || "");
          if(newTitle === null) return; // cancelled
          const trimmed = newTitle.trim();
          if(!trimmed){
            alert("Ù†Øµ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºÙ‹Ø§.");
            return;
          }
          t.title = trimmed;
          saveState(state);
          animateEl(row,"pulse");
          render();
        };

        const del = document.createElement("button");
        del.className="btn danger";
        del.textContent="Ø­Ø°Ù";
        del.onclick = () => {
          state[key].tasks = state[key].tasks.filter(x => x.id !== t.id);
          saveState(state);
          animateEl(card,"pulse");
          render();
        };

        status.appendChild(okChip);
        status.appendChild(noChip);
        row.appendChild(left);
        row.appendChild(status);
        row.appendChild(editBtn);
        row.appendChild(del);

        tasksWrap.appendChild(row);
      }

      card.appendChild(head);
      card.appendChild(addRow);
      card.appendChild(summary);
      card.appendChild(prog);
      card.appendChild(tasksWrap);

      grid.appendChild(card);
    }

    // heights may change (banner / content) -> keep fixed bars correct
    updateFixedHeights();
  }

  // Week nav
  document.getElementById("prevWeek").onclick = () => { weekOffset -= 1; render(); };
  document.getElementById("nextWeek").onclick = () => { weekOffset += 1; render(); };
  document.getElementById("goThisWeek").onclick = () => { weekOffset = 0; render(); };

  // Reset
  document.getElementById("resetAll").onclick = () => {
    if(confirm("Ù…ØªØ£ÙƒØ¯ Ø¨Ø¯Ùƒ ØªØ­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) {
      localStorage.removeItem(LS_STATE);
      localStorage.removeItem(LS_OFFSET);
      // don't delete theme preference unless you want
      location.reload();
    }
  };

  // Export / Import dialog
  const dlg = document.getElementById("ioDialog");
  const ioText = document.getElementById("ioText");

  function openDialogWith(text){
    ioText.value = text || "";
    if(typeof dlg.showModal === "function") dlg.showModal();
    else dlg.setAttribute("open","");
  }
  function closeDialog(){
    if(typeof dlg.close === "function") dlg.close();
    else dlg.removeAttribute("open");
  }

  document.getElementById("exportBtn").onclick = () => {
    const payload = { version: 6, exportedAt: new Date().toISOString(), state: loadState() };
    openDialogWith(JSON.stringify(payload, null, 2));
  };

  document.getElementById("importBtn").onclick = () => {
    openDialogWith("");
    ioText.placeholder = "Ø§Ù„ØµÙ‚ Ù‡Ù†Ø§ Ù†Øµ Ø§Ù„ØªØµØ¯ÙŠØ± (JSON)â€¦";
  };

  document.getElementById("copyBtn").onclick = async () => {
    try{
      await navigator.clipboard.writeText(ioText.value);
      alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…");
    }catch{
      ioText.focus(); ioText.select();
      alert("Ø­Ø¯Ø¯Ù†Ø§ Ø§Ù„Ù†Øµâ€”Ø§Ù†Ø³Ø®Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§ âœ…");
    }
  };

  document.getElementById("applyImportBtn").onclick = () => {
    const raw = ioText.value.trim();
    if(!raw){ alert("Ø§Ù„ØµÙ‚ Ù†Øµ JSON Ø£ÙˆÙ„Ø§Ù‹."); return; }
    let payload;
    try{ payload = JSON.parse(raw); }catch{ alert("Ø§Ù„Ù†Øµ Ù…Ùˆ JSON ØµØ­ÙŠØ­."); return; }
    if(!payload || typeof payload !== "object" || !payload.state){
      alert("ØµÙŠØºØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† ÙÙŠÙ‡Ø§ state.");
      return;
    }
    const incoming = payload.state;
    const current = loadState();

    for(const [dateKey, dayObj] of Object.entries(incoming)){
      if(!dayObj || !Array.isArray(dayObj.tasks)) continue;
      if(!current[dateKey]) current[dateKey] = { tasks: [] };

      const existing = current[dateKey].tasks || [];
      const map = new Map();
      for(const t of existing){
        const k = t.id || ("t:" + t.title);
        map.set(k, t);
      }
      for(const t of dayObj.tasks){
        const k = t.id || ("t:" + t.title);
        if(!map.has(k)) map.set(k, t);
        else{
          const cur = map.get(k);
          const merged = {
            id: t.id || cur.id,
            title: t.title || cur.title,
            status: (cur.status === "ok" || t.status === "ok") ? "ok" : (t.status || cur.status || "none")
          };
          map.set(k, merged);
        }
      }
      current[dateKey].tasks = Array.from(map.values());
    }

    localStorage.setItem(LS_STATE, JSON.stringify(current));
    alert("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ âœ…");
    closeDialog();
    // reload state in-memory
    Object.keys(state).forEach(k=>delete state[k]);
    Object.assign(state, loadState());
    render();
  };

  document.getElementById("closeDialogBtn").onclick = closeDialog;


  const LS_NOTES = "weekly_ach_notes_v6"; // { [weekStartIso]: "text" }

  function loadNotes(){
    try { return JSON.parse(localStorage.getItem(LS_NOTES) || "{}"); }
    catch { return {}; }
  }
  function saveNotesObj(obj){
    localStorage.setItem(LS_NOTES, JSON.stringify(obj));
  }

  const notesText = document.getElementById("notesText");
  const notesSub = document.getElementById("notesSub");
  const saveNotesBtn = document.getElementById("saveNotesBtn");
  const clearNotesBtn = document.getElementById("clearNotesBtn");
  const bottomQuickStats = document.getElementById("bottomQuickStats");

  // ===== Weekly tasks UI refs =====
  const weeklyInput = document.getElementById("weeklyInput");
  const weeklyAddBtn = document.getElementById("weeklyAddBtn");
  const weeklyTasksWrap = document.getElementById("weeklyTasksWrap");
  const weeklySub = document.getElementById("weeklySub");
  const weeklyStatsLine = document.getElementById("weeklyStatsLine");
  const weeklyProgressBar = document.getElementById("weeklyProgressBar");
  const clearWeeklyBtn = document.getElementById("clearWeeklyBtn");

  let weeklyObj = loadWeekly();


  let notesObj = loadNotes();
  let currentWeekKey = ""; // weekStart ISO

  function syncNotesUI(weekStartDate){
    currentWeekKey = isoDate(weekStartDate);
    notesSub.textContent = `Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙŠØ¨Ø¯Ø£: ${formatDate(weekStartDate)}`;
    notesText.value = notesObj[currentWeekKey] || "";
  }


  function ensureWeekly(weekKey){
    if(!weeklyObj[weekKey]) weeklyObj[weekKey] = { tasks: [] };
  }

  function renderWeekly(weekStartDate){
    const weekKey = isoDate(weekStartDate);
    ensureWeekly(weekKey);

    weeklySub.textContent = `Ù…Ù‡Ø§Ù… Ø£Ø³Ø¨ÙˆØ¹ ÙŠØ¨Ø¯Ø£: ${formatDate(weekStartDate)}`;
    const tasks = weeklyObj[weekKey].tasks;

    const st = stats(tasks);
    weeklyStatsLine.textContent = `Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: âœ… ${st.done}/${st.total} â€” Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${st.remaining} â€” ${st.pct}%`;
    weeklyProgressBar.style.width = `${st.pct}%`;

    weeklyTasksWrap.innerHTML = "";

    for(const t of tasks){
      const row = document.createElement("div");
      row.className="task";
      if(t.status==="ok") row.classList.add("done");
      if(t.status==="no") row.classList.add("notdone");

      const left = document.createElement("div");
      left.className="task-left";

      const title = document.createElement("div");
      title.className="task-title";
      title.textContent=t.title;

      left.appendChild(title);

      const statusWrap = document.createElement("div");
      statusWrap.className="status";

      const okChip = document.createElement("div");
      okChip.className="chip" + (t.status==="ok" ? " on-ok" : "");
      okChip.textContent="âœ… Ù…Ù†Ø¬Ø²";
      okChip.onclick = () => {
        const wasOk = (t.status==="ok");
        t.status = wasOk ? "none" : "ok";
        saveWeekly(weeklyObj);
        animateEl(row,"pulse");
        if(!wasOk) startConfetti(420);
        renderWeekly(weekStartDate);
      };

      const noChip = document.createElement("div");
      noChip.className="chip" + (t.status==="no" ? " on-no" : "");
      noChip.textContent="âŒ ØºÙŠØ± Ù…Ù†Ø¬Ø²";
      noChip.onclick = () => {
        const wasNo = (t.status==="no");
        t.status = wasNo ? "none" : "no";
        saveWeekly(weeklyObj);
        animateEl(row,"shake");
        renderWeekly(weekStartDate);
      };

      const editBtn = document.createElement("button");
      editBtn.className="btn";
      editBtn.textContent="ØªØ¹Ø¯ÙŠÙ„";
      editBtn.onclick = () => {
        const newTitle = prompt("Ø¹Ø¯Ù‘Ù„ Ù†Øµ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©:", t.title || "");
        if(newTitle === null) return;
        const trimmed = newTitle.trim();
        if(!trimmed){
          alert("Ù†Øµ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºÙ‹Ø§.");
          return;
        }
        t.title = trimmed;
        saveWeekly(weeklyObj);
        animateEl(row,"pulse");
        renderWeekly(weekStartDate);
      };

      const delBtn = document.createElement("button");
      delBtn.className="btn danger";
      delBtn.textContent="Ø­Ø°Ù";
      delBtn.onclick = () => {
        weeklyObj[weekKey].tasks = weeklyObj[weekKey].tasks.filter(x => x.id !== t.id);
        saveWeekly(weeklyObj);
        animateEl(row,"pulse");
        renderWeekly(weekStartDate);
      };

      statusWrap.appendChild(okChip);
      statusWrap.appendChild(noChip);

      row.appendChild(left);
      row.appendChild(statusWrap);
      row.appendChild(editBtn);
      row.appendChild(delBtn);

      weeklyTasksWrap.appendChild(row);
    }
  }


  saveNotesBtn.onclick = () => {
    notesObj[currentWeekKey] = notesText.value;
    saveNotesObj(notesObj);
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© âœ…");
  };

  clearNotesBtn.onclick = () => {
    if(confirm("ØªÙ…Ø³Ø­ Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŸ")) {
      notesText.value = "";
      notesObj[currentWeekKey] = "";
      saveNotesObj(notesObj);
    }
  };


  function weeklyAddCurrent(){
    const txt = (weeklyInput.value || "").trim();
    if(!txt) return;
    const weekDates = getWeekDates(weekOffset);
    const weekStartDate = weekDates[0];
    const weekKey = isoDate(weekStartDate);
    ensureWeekly(weekKey);
    weeklyObj[weekKey].tasks.push({
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
      title: txt,
      status: "none"
    });
    weeklyInput.value = "";
    saveWeekly(weeklyObj);
    renderWeekly(weekStartDate);
  }

  weeklyAddBtn.onclick = weeklyAddCurrent;
  weeklyInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") weeklyAddCurrent(); });

  clearWeeklyBtn.onclick = () => {
    const weekDates = getWeekDates(weekOffset);
    const weekStartDate = weekDates[0];
    const weekKey = isoDate(weekStartDate);
    if(confirm("ØªÙ…Ø³Ø­ ÙƒÙ„ Ù…Ù‡Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŸ")){
      ensureWeekly(weekKey);
      weeklyObj[weekKey].tasks = [];
      saveWeekly(weeklyObj);
      renderWeekly(weekStartDate);
    }
  };


  // Bottom nav wiring
  document.getElementById("prevWeekBottom").onclick = () => { weekOffset -= 1; render(); };
  document.getElementById("nextWeekBottom").onclick = () => { weekOffset += 1; render(); };
  document.getElementById("thisWeekBottom").onclick = () => { weekOffset = 0; render(); };

  document.getElementById("scrollTopBtn").onclick = () => {
    window.scrollTo({ top: 0, behavior: "smooth" });
  };


  // ===== Fixed bars sizing (so content doesn't go under them) =====
  function updateFixedHeights(){
    const topEl = document.querySelector(".top");
    const navEl = document.querySelector(".bottomNav");
    const topH = topEl ? Math.ceil(topEl.getBoundingClientRect().height) : 92;
    const navH = navEl ? Math.ceil(navEl.getBoundingClientRect().height) : 72;
    document.documentElement.style.setProperty("--topMainH", topH + "px");
    document.documentElement.style.setProperty("--topSecondH", navH + "px");
  }
  window.addEventListener("resize", updateFixedHeights);


  // init
  updateFixedHeights();
  render();
  // update once after layout
  setTimeout(updateFixedHeights, 50);

})();
</script>
</body>
</html>
